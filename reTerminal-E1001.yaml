esphome:
  name: reterminal-e1001
  friendly_name: reTerminal E1001
  on_boot:
    priority: 600
    then:
      # Turn on the GPIO output that powers the battery measurement circuit
      - output.turn_on: bsp_battery_enable
      # Wait a short delay to allow power stabilization
      - delay: 500ms
      # Manually update battery sensors (voltage and percentage)
      - component.update: battery_voltage
      # Manually read the internal temperature/humidity sensor
      - component.update: sht4x_component
esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf

# Enable logging
logger:

# Enable Home Assistant API (change key and password with yours)
api:
  encryption:
    key: "your_key"

ota:
  - platform: esphome
    password: "password"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails (change password with yours)
  ap:
    ssid: "Reterminal-E1001"
    password: "password"

captive_portal:

output:
  - platform: gpio
    pin: GPIO21
    id: bsp_battery_enable

time:
  - platform: homeassistant
    id: my_time
    timezone: Europe/Paris

color:
  - id: black
    hex: 'FFFFFF'   # black = 'FFFFFF' on reTerminalE1001 but '000000' on reTerminalE1002

font:
  - file: "gfonts://Inter@700"
    id: myFont14
    size: 14
  - file: "gfonts://Inter@700"
    id: myFont16
    size: 16    
  - file: "gfonts://Inter@700"
    id: myFont22
    size: 22      
  - file: "fonts/materialdesignicons-webfont.ttf"
    id: icon_font_22
    size: 22    
    glyphs:
      - "\U000F058E" # Humidity          
  - file: "gfonts://Inter@700"
    id: myFont44
    size: 44        
  - file: "fonts/materialdesignicons-webfont.ttf"
    id: icon_font_50
    size: 50
    glyphs:
      - "\U000F0590" # weather-cloudy - Nuageux
      - "\U000F0591" # weather-fog - Brouillard
      - "\U000F0592" # weather-hail - Grele      
      - "\U000F0593" # weather-lightning - Orage
      - "\U000F0594" # weather-clear-night - Nuit claire
      - "\U000F0595" # weather-partly-cloudy - Partiellement nuageux
      - "\U000F0596" # weather-pouring - Pluie forte
      - "\U000F0597" # weather-rainy - Pluie
      - "\U000F0598" # weather-snowy - Neige
      - "\U000F0599" # weather-sunny - Soleil
      - "\U000F0F30" # weather-hazy - brume
      - "\U000F0F31" # weather-night-partly-cloudy - Nuit partiellement nuageuse
      - "\U000F0F32" # weather-partly-lightning - Orage partiel
      - "\U000F0F33" # weather-partly-rainy - Pluie partielle
      - "\U000F0F34" # weather-partly-snowy - Neige partielle
      - "\U000F0F35" # weather-partly-snowy-rainy -Neige pluie partielle
      - "\U000F0F36" # weather-snowy-heavy - Neige forte
      - "\U000F059D" # weather-windy - Vent
      - "\U000F067E" # weather-lightning-rainy - Orage pluie
      - "\U000F059E" # weather-windy-variant - Vent variante
      - "\U000F0F2F" # weather-exceptional - Exceptionnel    
      - "\U000F18D7"  # température extérieure (sun-thermometer)
      - "\U000F0F55"  # température intérieure (home-thermometer)     
      - "\U000F058E"  # humidite (water-percent)     
      
  - file: "fonts/materialdesignicons-webfont.ttf"
    id: icon_font_80
    size: 80
    glyphs:
      - "\U000F0590" # weather-cloudy - Nuageux
      - "\U000F0591" # weather-fog - Brouillard
      - "\U000F0592" # weather-hail - Grele      
      - "\U000F0593" # weather-lightning - Orage
      - "\U000F0594" # weather-clear-night - Nuit claire
      - "\U000F0595" # weather-partly-cloudy - Partiellement nuageux
      - "\U000F0596" # weather-pouring - Pluie forte
      - "\U000F0597" # weather-rainy - Pluie
      - "\U000F0598" # weather-snowy - Neige
      - "\U000F0599" # weather-sunny - Soleil
      - "\U000F0F30" # weather-hazy - brume
      - "\U000F0F31" # weather-night-partly-cloudy - Nuit partiellement nuageuse
      - "\U000F0F32" # weather-partly-lightning - Orage partiel
      - "\U000F0F33" # weather-partly-rainy - Pluie partielle
      - "\U000F0F34" # weather-partly-snowy - Neige partielle
      - "\U000F0F35" # weather-partly-snowy-rainy -Neige pluie partielle
      - "\U000F0F36" # weather-snowy-heavy - Neige forte
      - "\U000F059D" # weather-windy - Vent
      - "\U000F067E" # weather-lightning-rainy - Orage pluie
      - "\U000F059E" # weather-windy-variant - Vent variante
      - "\U000F0F2F" # weather-exceptional - Exceptionnel
  
  - file: "fonts/materialdesignicons-webfont.ttf"
    id: icon_font_20
    size: 20
    glyphs:
      - "\U000F12A3" # battery-high
      - "\U000F12A2" # battery-medium
      - "\U000F12A1" # battery-low
      - "\U000F0083" # battery-alert
      - "\U000F058C" # water
      - "\U000F050F" # thermometer
      - "\U000F1442" # clock

# define SPI interface
spi:
  clk_pin: GPIO7
  mosi_pin: GPIO9

# define I2C interface
i2c:
  sda: GPIO19
  scl: GPIO20
  scan: false

text_sensor:
  # Daily text sensors
  - platform: homeassistant
    entity_id: sensor.daily_weather_forecast_sensor 
    attribute: day0
    id: day_d0
  - platform: homeassistant
    entity_id: sensor.daily_weather_forecast_sensor
    attribute: condition0
    id: condition_d0
  - platform: homeassistant
    entity_id: sensor.daily_weather_forecast_sensor 
    attribute: day1
    id: day_d1
  - platform: homeassistant
    entity_id: sensor.daily_weather_forecast_sensor
    attribute: condition1
    id: condition_d1
  - platform: homeassistant
    entity_id: sensor.daily_weather_forecast_sensor 
    attribute: day2
    id: day_d2
  - platform: homeassistant
    entity_id: sensor.daily_weather_forecast_sensor
    attribute: condition2
    id: condition_d2
  - platform: homeassistant
    entity_id: sensor.daily_weather_forecast_sensor 
    attribute: day3
    id: day_d3
  - platform: homeassistant
    entity_id: sensor.daily_weather_forecast_sensor
    attribute: condition3
    id: condition_d3
  - platform: homeassistant
    entity_id: sensor.daily_weather_forecast_sensor 
    attribute: day4
    id: day_d4
  - platform: homeassistant
    entity_id: sensor.daily_weather_forecast_sensor
    attribute: condition4
    id: condition_d4        
    # hourly text sensors
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: time0
    id: time_h0    
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: condition0
    id: condition_h0
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: time1
    id: time_h1    
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: condition1
    id: condition_h1
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: time2
    id: time_h2    
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: condition2
    id: condition_h2
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: time3
    id: time_h3    
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: condition3
    id: condition_h3
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: time4
    id: time_h4    
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: condition4
    id: condition_h4
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: time5
    id: time_h5    
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: condition5
    id: condition_h5
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: time6
    id: time_h6    
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: condition6
    id: condition_h6
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: time7
    id: time_h7    
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: condition7
    id: condition_h7
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: time8
    id: time_h8    
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: condition8
    id: condition_h8
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: time9
    id: time_h9    
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: condition9
    id: condition_h9
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: time10
    id: time_h10    
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: condition10
    id: condition_h10
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: time11
    id: time_h11    
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: condition11
    id: condition_h11


sensor:
  # ADC for battery voltage measurement
  - platform: adc
    pin: GPIO1
    name: "Battery Voltage"
    id: battery_voltage
    update_interval: 600s      
    attenuation: 12db
    filters:
      - multiply: 2.0  # Voltage divider compensation  
  # Internal SHT4x temperature/humidity sensor
  - platform: sht4x            # Sensor platform
    id: sht4x_component         # ID for the component
    temperature:                # Temperature sensor
      name: "Temperature"       # Sensor name
      id: sht4x_temperature     # ID for temperature sensor
    humidity:                   # Humidity sensor
      name: "Humidity"          # Sensor name
      id: sht4x_humidity        # ID for humidity sensor
    address: 0x44               # I2C address
    update_interval: never      # Disable automatic updates (manual read only)
  - platform: homeassistant
    id: outdoor_temperature_id
    entity_id: sensor.outdoor_temperature
    # Daily sensors
  - platform: homeassistant
    id: temperature_d0
    entity_id: sensor.daily_weather_forecast_sensor
    attribute: temperature0
    on_value:
      then:
        # Refresh the e-paper display whenever this sensor updates
        - component.update: epaper_display       
  - platform: homeassistant
    id: templow_d0
    entity_id: sensor.daily_weather_forecast_sensor
    attribute: templow0    
  - platform: homeassistant
    id: temperature_d1
    entity_id: sensor.daily_weather_forecast_sensor
    attribute: temperature1 
  - platform: homeassistant
    id: templow_d1
    entity_id: sensor.daily_weather_forecast_sensor
    attribute: templow1
  - platform: homeassistant
    id: temperature_d2
    entity_id: sensor.daily_weather_forecast_sensor
    attribute: temperature2 
  - platform: homeassistant
    id: templow_d2
    entity_id: sensor.daily_weather_forecast_sensor
    attribute: templow2
  - platform: homeassistant
    id: temperature_d3
    entity_id: sensor.daily_weather_forecast_sensor
    attribute: temperature3 
  - platform: homeassistant
    id: templow_d3
    entity_id: sensor.daily_weather_forecast_sensor
    attribute: templow3
  - platform: homeassistant
    id: temperature_d4
    entity_id: sensor.daily_weather_forecast_sensor
    attribute: temperature4 
  - platform: homeassistant
    id: templow_d4
    entity_id: sensor.daily_weather_forecast_sensor
    attribute: templow4   
    # Hourly sensors         
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: temperature0
    id: temperature_h0
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: precipitation0
    id: precipitation_h0

  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: temperature1
    id: temperature_h1
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: precipitation1
    id: precipitation_h1

  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: temperature2
    id: temperature_h2
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: precipitation2
    id: precipitation_h2

  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: temperature3
    id: temperature_h3
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: precipitation3
    id: precipitation_h3

  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: temperature4
    id: temperature_h4
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: precipitation4
    id: precipitation_h4

  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: temperature5
    id: temperature_h5
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: precipitation5
    id: precipitation_h5

  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: temperature6
    id: temperature_h6
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: precipitation6
    id: precipitation_h6

  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: temperature7
    id: temperature_h7
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: precipitation7
    id: precipitation_h7

  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: temperature8
    id: temperature_h8
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: precipitation8
    id: precipitation_h8

  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: temperature9
    id: temperature_h9
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: precipitation9
    id: precipitation_h9

  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: temperature10
    id: temperature_h10
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: precipitation10
    id: precipitation_h10

  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: temperature11
    id: temperature_h11
  - platform: homeassistant
    entity_id: sensor.hourly_weather_forecast_sensor
    attribute: precipitation11
    id: precipitation_h11

display:
  # reTerminalE1001
  - platform: waveshare_epaper
    id: epaper_display
    model: 7.50inv2
    cs_pin: GPIO10
    dc_pin: GPIO11
    reset_pin:
      number: GPIO12
      inverted: false
    busy_pin:
      number: GPIO13
      inverted: true
    update_interval: never
    lambda: |-

      const char* icon;
      int base_x, base_y;
      int text_width;
      int x_offset;
      int baseline;
      int height;
      char buffer[25];    

      // check date are received before display
      if (!id(temperature_d0).has_state()) {
        it.printf(0, 0, id(myFont22), "Waiting weather data...");
        return;
      }
      
      // INDOOR / OUTDOOR TEMPERATURE
      // ----------------------------------
      base_x = 30;
      base_y = 90;

      it.printf(base_x, base_y, id(icon_font_50), id(black), "\U000F18D7");
      it.printf(base_x+60, base_y, id(myFont44), id(black), "%.1f°", id(outdoor_temperature_id).state);
      it.printf(base_x, base_y+70, id(icon_font_50), id(black), "\U000F0F55");
      it.printf(base_x+60, base_y+70, id(myFont44), id(black), "%.1f°", id(sht4x_temperature).state);
      it.printf(base_x, base_y+140, id(icon_font_50), id(black), "\U000F058E");
      it.printf(base_x+60, base_y+140, id(myFont44), id(black), "%.0f%%", id(sht4x_humidity).state);

      // DATE
      // ----
      base_y = 5;
      snprintf(buffer, sizeof(buffer), "%s, %s %d",
               my_time->now().strftime("%A").c_str(),
               my_time->now().strftime("%B").c_str(),
               my_time->now().day_of_month);      
      id(myFont44).measure(buffer, &text_width, &x_offset, &baseline, &height);

      // Calculating the X position to center the text
      base_x = (800 - text_width) / 2;        
      it.printf(base_x, base_y, id(myFont44), id(black), "%s", buffer);
      

      // DAILY FORECAST
      // ----------------------------
      // Days
      std::string jour_jours[5] = {
        id(day_d0).state,
        id(day_d1).state,
        id(day_d2).state,
        id(day_d3).state,
        id(day_d4).state
      };

      // Max temperatures
      float temperature_max_days[5] = {
        id(temperature_d0).state,
        id(temperature_d1).state,
        id(temperature_d2).state,
        id(temperature_d3).state,
        id(temperature_d4).state
      };      
      // Min temperatures
      float temperature_min_days[5] = {
        id(templow_d0).state,
        id(templow_d1).state,
        id(templow_d2).state,
        id(templow_d3).state,
        id(templow_d4).state
      };            
      
      // Conditions
      std::string condition_day[5] = {
        id(condition_d0).state,
        id(condition_d1).state,
        id(condition_d2).state,
        id(condition_d3).state,
        id(condition_d4).state
      };

      for (int i = 0; i < 5; i++) {
        if (condition_day[i] == "sunny") {
          icon = "\U000F0599"; // soleil
        } else if (condition_day[i] == "partlycloudy") {
          icon = "\U000F0595"; // partiellement nuageux
        } else if (condition_day[i] == "cloudy") {
          icon = "\U000F0590"; // nuageux
        } else if (condition_day[i] == "rainy") {
          icon = "\U000F0597"; // pluie
        } else if (condition_day[i] == "snowy") {
          icon = "\U000F0598"; // neige
        } else if (condition_day[i] == "pouring") {
          icon = "\U000F0596"; // pluie forte          
        } else if (condition_day[i] == "lightning") {
          icon = "\U000F0593"; // orage          
        } else if (condition_day[i] == "clear-night") {
          icon = "\U000F0594"; // nuit claire  
        } else if (condition_day[i] == "night-partlycloudy") {
          icon = "\U000F0F31"; // nuit partiellement nuageuse      
        } else if (condition_day[i] == "fog") {
          icon = "\U000F0591"; // brouillard      
        } else if (condition_day[i] == "hail") {
          icon = "\U000F0592"; // grele    
        } else if (condition_day[i] == "lightning-rainy") {
          icon = "\U000F067E"; // orage pluie                   
        } else if (condition_day[i] == "snowy-rainy") {
          icon = "\U000F0F35"; // neige pluie                     
        } else if (condition_day[i] == "windy") {
          icon = "\U000F059D"; // vent         
        } else if (condition_day[i] == "windy-variant") {
          icon = "\U000F059E"; // vent                                                 
        } else if (condition_day[i] == "exceptional") {
          icon = "\U000F0F2F"; // exceptionnel       
        } else {                
          icon = "\U000F0F2F"; // défaut 
        }


        // Calculating the X position to center the text
        base_x = 240 + 110*i;
        base_y = 90;
        id(myFont22).measure(jour_jours[i].c_str(), &text_width, &x_offset, &baseline, &height);
        int x_jour = base_x + (110 - text_width) / 2; 
        id(icon_font_80).measure(icon, &text_width, &x_offset, &baseline, &height);
        int x_icon = base_x + (110 - text_width) / 2; 
        snprintf(buffer, sizeof(buffer), "%.0f", temperature_max_days[i]);
        id(myFont22).measure(buffer, &text_width, &x_offset, &baseline, &height);
        int x_temp_max = base_x + (110 - text_width) / 2; 
        snprintf(buffer, sizeof(buffer), "%.0f", temperature_min_days[i]);
        id(myFont22).measure(buffer, &text_width, &x_offset, &baseline, &height);
        int x_temp_min = base_x + (110 - text_width) / 2; 
        it.printf(x_jour, base_y, id(myFont22), id(black), "%s", jour_jours[i].c_str());
        it.printf(x_icon, base_y+40, id(icon_font_80), id(black), "%s", icon);
        it.printf(x_temp_max, base_y+130, id(myFont22), id(black), "%.0f°", temperature_max_days[i]);
        it.printf(x_temp_min, base_y+160, id(myFont22), id(black), "%.0f°", temperature_min_days[i]);        
      }      


      // HOURLY FORECAST
      // Time list
      std::string time_values[12] = {
        id(time_h0).state,
        id(time_h1).state,
        id(time_h2).state,
        id(time_h3).state,
        id(time_h4).state,
        id(time_h5).state,
        id(time_h6).state,
        id(time_h7).state,
        id(time_h8).state,
        id(time_h9).state,
        id(time_h10).state,
        id(time_h11).state
      };

      // Precipitation list
      float precipitation_values[12] = {
        id(precipitation_h0).state,
        id(precipitation_h1).state,
        id(precipitation_h2).state,
        id(precipitation_h3).state,
        id(precipitation_h4).state,
        id(precipitation_h5).state,
        id(precipitation_h6).state,
        id(precipitation_h7).state,
        id(precipitation_h8).state,
        id(precipitation_h9).state,
        id(precipitation_h10).state,
        id(precipitation_h11).state
      };

      // Temperatures list
      float temperature_values[12] = {
        id(temperature_h0).state,
        id(temperature_h1).state,
        id(temperature_h2).state,
        id(temperature_h3).state,
        id(temperature_h4).state,
        id(temperature_h5).state,
        id(temperature_h6).state,
        id(temperature_h7).state,
        id(temperature_h8).state,
        id(temperature_h9).state,
        id(temperature_h10).state,
        id(temperature_h11).state
      };      
      
      // Condition list
      std::string condition_values[12] = {
        id(condition_h0).state,
        id(condition_h1).state,
        id(condition_h2).state,
        id(condition_h3).state,
        id(condition_h4).state,
        id(condition_h5).state,
        id(condition_h6).state,
        id(condition_h7).state,
        id(condition_h8).state,
        id(condition_h9).state,
        id(condition_h10).state,
        id(condition_h11).state
      };

      base_x = 30;
      base_y = 310;
      it.printf(base_x, base_y+60, id(icon_font_20), id(black), "\U000F1442");  // time
      it.printf(base_x, base_y+85, id(icon_font_20), id(black), "\U000F050F");  // temperature
      it.printf(base_x, base_y+110, id(icon_font_20), id(black), "\U000F058C"); // precipication

      for (int i = 0; i < 12; i++) {
        if (condition_values[i] == "sunny") {
          icon = "\U000F0599"; // soleil
        } else if (condition_values[i] == "partlycloudy") {
          icon = "\U000F0595"; // partiellement nuageux
        } else if (condition_values[i] == "cloudy") {
          icon = "\U000F0590"; // nuageux
        } else if (condition_values[i] == "rainy") {
          icon = "\U000F0597"; // pluie
        } else if (condition_values[i] == "snowy") {
          icon = "\U000F0598"; // neige
        } else if (condition_values[i] == "pouring") {
          icon = "\U000F0596"; // pluie forte          
        } else if (condition_values[i] == "lightning") {
          icon = "\U000F0593"; // orage          
        } else if (condition_values[i] == "clear-night") {
          icon = "\U000F0594"; // nuit claire  
        } else if (condition_values[i] == "night-partlycloudy") {
          icon = "\U000F0F31"; // nuit partiellement nuageuse      
        } else if (condition_values[i] == "fog") {
          icon = "\U000F0591"; // brouillard      
        } else if (condition_values[i] == "hail") {
          icon = "\U000F0592"; // grele    
        } else if (condition_values[i] == "lightning-rainy") {
          icon = "\U000F067E"; // orage pluie                   
        } else if (condition_values[i] == "snowy-rainy") {
          icon = "\U000F0F35"; // neige pluie                     
        } else if (condition_values[i] == "windy") {
          icon = "\U000F059D"; // vent         
        } else if (condition_values[i] == "windy-variant") {
          icon = "\U000F059E"; // vent                                                 
        } else if (condition_values[i] == "exceptional") {
          icon = "\U000F0F2F"; // exceptionnel       
        } else {                
          icon = "\U000F0F2F"; // défaut 
        }

      base_x = 50 + 60*i;
      // icon_time
      id(icon_font_50).measure(icon, &text_width, &x_offset, &baseline, &height);
      int x_icon = base_x + (60 - text_width) / 2;       
      it.printf(x_icon, base_y, id(icon_font_50), id(black), "%s", icon);
      // time
      id(myFont16).measure(time_values[i].c_str(), &text_width, &x_offset, &baseline, &height);
      int x_time = base_x + (60 - text_width) / 2; 
      it.printf(x_time, base_y+60, id(myFont16), id(black), "%s", time_values[i].c_str());
      // temperature
      snprintf(buffer, sizeof(buffer), "%.0f", temperature_values[i]);
      id(myFont16).measure(buffer, &text_width, &x_offset, &baseline, &height);
      int x_temp = base_x + (60 - text_width) / 2; 
      it.printf(x_temp, base_y+85, id(myFont16), id(black), "%.0f°", temperature_values[i]);
      // precipication
      snprintf(buffer, sizeof(buffer), "%.1f", precipitation_values[i]);
      id(myFont16).measure(buffer, &text_width, &x_offset, &baseline, &height);
      int x_precip = base_x + (60 - text_width) / 2; 
      it.printf(x_precip, base_y+110, id(myFont16), id(black), "%.1f", precipitation_values[i]);
      }   

      // BATTERY VOLTAGE
      if (id(battery_voltage).state >= 3.8) {
        it.printf(730, 450, id(icon_font_20), id(black), "\U000F12A3"); // battery full
      } else if (id(battery_voltage).state >= 3.6) {
        it.printf(730, 450, id(icon_font_20), id(black), "\U000F12A2"); // battery medium
      } else {
        it.printf(730, 450, id(icon_font_20), id(black), "\U000F12A1"); // battery low
      }
      it.printf(750, 452, id(myFont14), id(black), "%.1fV", id(battery_voltage).state);
   

# Deep sleep configuration to save power
deep_sleep:
  id: deep_sleep_1              # ID for deep sleep component
  run_duration: 30s             # Time to stay awake after wake-up
  sleep_duration: 30min         # Time to sleep between wake-ups
  wakeup_pin: GPIO3             # GPIO pin to wake up device
  wakeup_pin_mode: INVERT_WAKEUP # Inverted wake-up logic      
